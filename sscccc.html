<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SSC CHSL Tier-I Mathematics Practice Test</title>
    <style>
        /* (unchanged CSS — same as your original file) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; }
        .container { max-width:1200px;margin:0 auto;padding:20px; }
        .header { text-align:center;background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);margin-bottom:30px;border-top:5px solid #e74c3c; }
        .govt-logo{width:80px;height:80px;background:#e74c3c;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold;}
        .header h1{color:#2c3e50;margin-bottom:10px;font-size:2.4em;font-weight:bold;text-transform:uppercase;letter-spacing:1px;}
        .header h2{color:#e74c3c;font-weight:bold;margin-bottom:10px;font-size:1.3em;}
        .header .subtitle{color:#7f8c8d;font-size:1.1em;margin-bottom:20px;font-style:italic;}
        .exam-info {
    background: #f8f9fa;
    padding: 25px 30px;
    border-radius: 12px;
    margin: 20px 0;
    border-left: 6px solid #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
    max-width: 100%;
    text-align: left; /* align text to the left */
    font-size: 16px;
    line-height: 1.6;
    color: #2c3e50;
}

.exam-info h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-weight: 700;
    font-size: 1.5em;
    text-align: left; /* ensure heading is aligned left */
}

.exam-info ul {
    list-style: none;
    padding-left: 20px; /* padding for bullet alignment */
    margin: 0;
}

.exam-info li {
    margin: 8px 0;
    padding-left: 20px;
    position: relative;
    text-align: left;
}

.exam-info li:before {
    content: "•"; /* bullet */
    color: #3498db;
    font-weight: bold;
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
}
.btn{background:linear-gradient(45deg,#3498db,#2980b9);color:white;border:none;padding:18px 35px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s ease;margin:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
        .btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}
        .btn-admin{background:linear-gradient(45deg,#e74c3c,#c0392b);}
        .quiz-container{display:none;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;}
        .exam-header{background:linear-gradient(45deg,#2c3e50,#34495e);color:white;padding:20px 30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
        .exam-title{font-size:1.3em;font-weight:bold;}
        .timer-container{background:#e74c3c;padding:12px 20px;border-radius:8px;font-family:'Courier New',monospace;font-size:1.2em;font-weight:bold;box-shadow:0 2px 10px rgba(0,0,0,0.3);min-width:160px;text-align:center;}
        .timer-label{font-size:0.8em;margin-bottom:5px;opacity:0.9;}
        .timer-display{font-size:1.4em;letter-spacing:2px;}
        .timer-warning{background:#f39c12 !important;animation:pulse 1s infinite;}
        .timer-critical{background:#e74c3c !important;animation:flash 0.5s infinite;}
        @keyframes pulse{0%{opacity:1;}50%{opacity:0.7;}100%{opacity:1;}}
        @keyframes flash{0%{opacity:1;}50%{opacity:0.3;}100%{opacity:1;}}
        .user-form{background:#f8f9fa;padding:30px;border-bottom:1px solid #e9ecef;}
        .user-form h3{color:#2c3e50;margin-bottom:20px;font-size:1.4em;}
        .user-form input{width:100%;padding:15px;margin:10px 0;border:2px solid #ddd;border-radius:6px;font-size:16px;transition:border-color 0.3s ease;}
        .user-form input:focus{outline:none;border-color:#3498db;box-shadow:0 0 0 3px rgba(52,152,219,0.1);}
        .question-container{display:none;padding:30px;}
        .question-container.active{display:block;}
        .question{background:#fff;border:2px solid #e9ecef;border-radius:10px;padding:30px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
        .question-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #e9ecef;}
        .question-number{background:linear-gradient(45deg,#3498db,#2980b9);color:white;padding:10px 20px;border-radius:25px;font-weight:bold;font-size:16px;}
        .question-text{font-size:18px;margin-bottom:25px;color:#2c3e50;line-height:1.8;font-weight:500;}
        .options{list-style:none;}
        .option{margin-bottom:15px;padding:15px 20px;border:2px solid #e9ecef;border-radius:8px;cursor:pointer;transition:all 0.3s ease;background:#f8f9fa;position:relative;}
        .option:hover{background:#e3f2fd;border-color:#2196f3;transform:translateX(5px);}
        .option.selected{background:linear-gradient(45deg,#3498db,#2980b9);border-color:#2980b9;color:white;font-weight:bold;}
        .option label{cursor:pointer;display:block;width:100%;font-size:16px;}
        .navigation{display:flex;justify-content:space-between;align-items:center;padding:25px 30px;background:#f8f9fa;border-top:1px solid #e9ecef;}
        .btn-nav{background:linear-gradient(45deg,#27ae60,#2ecc71);color:white;border:none;padding:12px 25px;border-radius:6px;cursor:pointer;font-size:16px;font-weight:bold;text-transform:uppercase;transition:all 0.3s ease;box-shadow:0 3px 10px rgba(0,0,0,0.2);}
        .btn-nav:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
        .btn-nav:disabled{background:#bdc3c7;cursor:not-allowed;transform:none;box-shadow:none;}
        #submitBtn{background:linear-gradient(45deg,#e74c3c,#c0392b) !important;}
        .progress{flex:1;margin:0 20px;text-align:center;color:#2c3e50;font-size:18px;font-weight:bold;background:white;padding:10px 20px;border-radius:25px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);backdrop-filter:blur(5px);}
        .modal-content{background-color:#fff;margin:10% auto;padding:40px;border-radius:12px;width:90%;max-width:500px;box-shadow:0 10px 40px rgba(0,0,0,0.3);border-top:5px solid #e74c3c;}
        .modal h3{margin-bottom:25px;color:#2c3e50;font-size:1.5em;}
        .modal input{width:100%;padding:15px;margin:15px 0;border:2px solid #ddd;border-radius:6px;font-size:16px;}
        .close{color:#aaa;float:right;font-size:32px;font-weight:bold;cursor:pointer;margin-top:-15px;}
        .close:hover{color:#e74c3c;}
        .admin-panel{display:none;background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);border-top:5px solid #e74c3c;}
        .response-table{width:100%;border-collapse:collapse;margin-top:20px;font-size:14px;}
        .response-table th,.response-table td{border:1px solid #ddd;padding:12px;text-align:left;}
        .response-table th{background:linear-gradient(45deg,#2c3e50,#34495e);color:white;font-weight:bold;}
        .response-table tr:nth-child(even){background-color:#f9f9f9;}
        .success-message{background:linear-gradient(45deg,#27ae60,#2ecc71);color:white;padding:40px;border-radius:12px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
        .success-message h3{font-size:2em;margin-bottom:20px;}
        .error-message{background:#f8d7da;color:#721c24;padding:15px;border-radius:8px;text-align:center;margin-top:10px;border:1px solid #f5c6cb;}
        .auto-submit-warning{background:#fff3cd;color:#856404;padding:20px;border-radius:8px;text-align:center;margin:20px 0;border:1px solid #ffeaa7;font-weight:bold;}
        /* responsive css omitted for brevity in this snippet - same as your original file */
    </style>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
</head>
<body>
    <div class="container">
        <!-- Landing Page -->
        <div id="landingPage">
            <div class="header">
                <div class="govt-logo">SSC</div>
                <h1>Staff Selection Commission</h1>
                <h2>CHSL Tier-I Mathematics Practice Test 2</h2>
                <p class="subtitle">Combined Higher Secondary Level Examination</p>
                <div class="exam-info">
                    <h3>Examination Instructions:</h3>
                    <ul>
                        <li>Total Questions: 45</li>
                        <li>Maximum Marks: 90</li>
                        <li>Time Duration: <strong style="color: rgb(253, 5, 5); font-weight: 1000; ">1 Hour 15 Minutes</strong></li>
                        <li><strong style="color: rgb(253, 5, 5); font-weight: 1000;">⚠️ Test will auto-submit when time expires</strong></li>
                        <li>Ensure stable internet connection</li>
                        <li><strong style="color: rgb(253, 5, 5); font-weight: 1000;">Do not refresh the page during exam</strong></li>
                        <li>Marking Scheme: +2 for correct, -0.5 for incorrect, 0 for unattempted</li>
                    </ul>
                </div>
                <button class="btn" onclick="startTest()">Start Examination</button>
                <button class="btn btn-admin" onclick="openAdminModal()">Admin Panel</button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="quiz-container">
            <div class="exam-header">
                <div class="exam-title">SSC CHSL - Mathematics Practice Test</div>
                <div class="timer-container" id="timerContainer">
                    <div class="timer-label">TIME REMAINING</div>
                    <div class="timer-display" id="timerDisplay">01:15:00</div>
                </div>
            </div>

            <!-- User Information Form -->
            <div id="userForm" class="user-form">
                <h3>Candidate Information</h3>
                <input type="text" id="userName" placeholder="Enter your Name" required>
                <input type="email" id="userEmail" placeholder="Enter Given email address" required>
                <button class="btn" onclick="startQuiz()">Begin Examination</button>
            </div>

            <!-- Auto Submit Warning -->
            <div id="autoSubmitWarning" class="auto-submit-warning" style="display: none;">
                ⚠️ WARNING: Test will be automatically submitted in less than 5 minutes!
            </div>

            <!-- Questions will be dynamically inserted here -->
            <div id="questionsContainer"></div>

            <!-- Navigation -->
            <div class="navigation" id="navigation" style="display: none;">
                <button class="btn-nav" id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
                <div class="progress" id="progress">Question 1 of 45</div>
                <button class="btn-nav" id="nextBtn" onclick="nextQuestion()">Next</button>
                <button class="btn-nav" id="submitBtn" onclick="submitTest()" style="display: none;">Submit Test</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
    <h2 style="color: #2c3e50; margin-bottom: 20px;">Admin Panel - User Responses</h2>
    <div style="margin-bottom: 20px;">
        <button class="btn" onclick="downloadRawDataCSV()" style="background: #3498db;">Download Raw Data (CSV)</button>
        <button class="btn" onclick="downloadResultsCSV()" style="background: #27ae60;">Download Final Results (CSV)</button>
        <button class="btn" onclick="clearAllResponses()" style="background: #e74c3c;">Clear All Data</button>
        <button class="btn" onclick="goHome()">Back to Home</button>
    </div>
    <div id="responsesContainer">
        <p>No responses yet.</p>
    </div>
    <div style="margin-top:12px;color:#666;font-size:13px;">
        <strong>Note:</strong> Responses are stored in JSONBin. If you want the master key removed from the client, move persistence to a server.
    </div>
</div>
        <!-- Success Message -->
        <div id="successMessage" style="display: none;" class="success-message">
            <h3>✅ Test Submitted Successfully!</h3>
            <p>Thank you for taking the SSC CHSL Mathematics Practice Test.<br>Your responses have been recorded successfully.</p>
            <button class="btn" onclick="goHome()" style="margin-top: 20px; background: white; color: #2c3e50;">Back to Home</button>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <h3>Admin Access</h3>
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <div id="passwordError" class="error-message" style="display: none;">Incorrect password!</div>
            <button class="btn" onclick="checkAdminPassword()">Login</button>
        </div>
    </div>

    <script>
        /************************
         * JSONBin configuration
         *
         * WARNING: Embedding X-Master-Key in client-side code is insecure.
         * Recommended: move these operations to a small server-side endpoint.
         ************************/
        const JSONBIN_ID = '68d903e243b1c97be952d590';
        const JSONBIN_MASTER_KEY = '$2a$10$XZzc.4ipvMjGFeEh9J/7cuffWTZGYXoXCkJjMDjZ1wCgz.BGJ3Cse';

        // Helper: JSONBin v3 endpoints
        const JSONBIN_BASE = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;

        // Questions data (unchanged)
        const questions = [
            /* (same questions array as in your original file) */
                            
                            {
                              "question": "If $\\cot A = \\frac{15}{8}$, then the value of $\\tan 2A$ will be:",
                              "options": ["$\\frac{240}{173}$", "$\\frac{240}{161}$", "$\\frac{220}{171}$", "$\\frac{200}{161}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $2a+b=10$ and $2ab=9$, then the value of $(2a-b)$ will be:",
                              "options": ["10", "4", "8", "6"],
                              "correct": 2
                            },
                            {
                              "question": "If $3\\sqrt{\\frac{1-a}{a}}+9=19-3\\sqrt{\\frac{a}{1-a}}$ then what is the value of $a$?",
                              "options": ["$3/10, 7/10$", "$1/10, 9/10$", "$2/5, 3/5$", "$1/5, 4/5$"],
                              "correct": 1
                            },
                            {
                              "question": "Simplify the following expression $(3x+2y)^{2}-(3x-2y)^{2}$.",
                              "options": ["$9x^{2}-4y^{2}$", "$12xy$", "$18x^{2}-8y^{2}$", "$24xy$"],
                              "correct": 3
                            },
                            {
                              "question": "If $x+y=2$ and $\\frac{1}{x}+\\frac{1}{y}=\\frac{18}{5}$, then the value of $(x^{3}+y^{3})$ is:",
                              "options": ["$4\\frac{2}{3}$", "$4\\frac{3}{5}$", "$3\\frac{1}{5}$", "$3\\frac{1}{3}$"],
                              "correct": 0
                            },
                            {
                              "question": "In right-angled triangle PQR, $PQ=5\\text{ cm}$, $QR = 13\\text{ cm}$ and $\\angle P=90^{\\circ}$ then find the value of $(\\tan Q - \\tan R)$.",
                              "options": ["$\\frac{60}{119}$", "$\\frac{119}{60}$", "$\\frac{14}{5}$", "$\\frac{5}{14}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $\\sin \\theta=\\frac{8}{17}$ then find the value of $\\tan \\theta$.",
                              "options": ["$\\frac{15}{17}$", "$\\frac{8}{15}$", "$\\frac{17}{8}$", "$\\frac{15}{8}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $x^{2}-4x+1=0,$ then what is the value of $x^{9}+x^{7}-194x^{5}-194x^{3}$?",
                              "options": ["4", "-4", "1", "-1"],
                              "correct": 1
                            },
                            {
                              "question": "If $x=2+\\sqrt{3}$, find the value of $x^{4}-8x^{3}+16x^{2}$.",
                              "options": ["1", "3", "0", "2"],
                              "correct": 0
                            },
                            {
                              "question": "If $x^{2}-3\\sqrt{2}x+1=0$ then what is the value of $x^{3}+\\frac{1}{x^{3}}$?",
                              "options": ["$30\\sqrt{6}$", "$45\\sqrt{2}$", "$15\\sqrt{6}$", "$30\\sqrt{2}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $a+b+c=\\frac{7}{12}$, $3a-4b+5c=\\frac{3}{4}$ and $7a-11b-13c=-\\frac{7}{12}$, then what is the value of $a+c$?",
                              "options": ["$1/2$", "$5/12$", "$3/4$", "$1/4$"],
                              "correct": 1
                            },
                            {
                              "question": "The value of $\\cos 120^{\\circ}$ is:",
                              "options": ["1", "-0.5", "0", "0.5"],
                              "correct": 1
                            },
                            {
                              "question": "If $a^{2}+b^{2}+c^{2}=a b+b c+c a$ then the value of $\\frac{11a^{4}+13b^{4}+15c^{4}}{16a^{2}b^{2}+19b^{2}c^{2}+17c^{2}a^{2}}$ is:",
                              "options": ["$\\frac{1}{4}$", "$\\frac{3}{4}$", "$1\\frac{1}{3}$", "$1\\frac{3}{4}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $x^{4}+\\frac{1}{x^{4}}=727$, $x>1$. then what is the value of $(x-\\frac{1}{x})$?",
                              "options": ["$\\pm 6$", "$\\pm 5$", "$\\pm 4$", "$\\pm 3$"],
                              "correct": 1
                            },
                            {
                              "question": "$\\triangle ABC$ is a right angle triangle. If $\\angle B=90^{\\circ}$ and $\\tan A=\\frac{1}{\\sqrt{3}}$ then find the value of $(\\sin A \\cos C + \\cos A \\sin C)$.",
                              "options": ["$\\frac{1}{3}$", "$\\frac{2}{3}$", "2", "1"],
                              "correct": 3
                            },
                            {
                              "question": "If $x=4+\\sqrt{15}$, what is the value of $(x^{2}+\\frac{1}{x^{2}})$?",
                              "options": ["48", "54", "72", "62"],
                              "correct": 3
                            },
                            {
                              "question": "If $\\sqrt{x}+\\frac{1}{\\sqrt{x}}=2\\sqrt{3}$ then $x^{4}+\\frac{1}{x^{4}}$ will be:",
                              "options": ["10406", "9602", "9606", "10402"],
                              "correct": 1
                            },
                            {
                              "question": "If $x^{4}+\\frac{1}{x^{4}}=14159$, then the value of $x+\\frac{1}{x}$ is:",
                              "options": ["9", "10", "11", "12"],
                              "correct": 2
                            },
                            {
                              "question": "If $\\sec \\theta - 2 \\cos \\theta = \\frac{7}{2}$ where $\\theta$ is positive acute angle, then the value of $\\sec \\theta$ is.",
                              "options": ["5", "6", "4", "8"],
                              "correct": 2
                            },
                            {
                              "question": "A man buys 2 apples and 3 kiwi fruits for $₹ 37$. If he buys 4 apples and 5 kiwi fruits for $₹ 67$ then what will be the total cost of 1 apple and 1 kiwi fruit?",
                              "options": ["$₹ 20$", "$₹ 18$", "$₹ 15$", "$₹ 28$"],
                              "correct": 2
                            },
                            {
                              "question": "The value of $\\frac{1}{8}[\\frac{1}{b-1}-\\frac{1}{b+1}-\\frac{2}{b^{2}+1}-\\frac{4}{b^{4}+1}]$ is:",
                              "options": ["$\\frac{1}{b^{8}-1}$", "$\\frac{1}{b^{8}+1}$", "$\\frac{8}{b^{8}+1}$", "$\\frac{8}{b^{8}-1}$"],
                              "correct": 0
                            },
                            {
                              "question": "If $a=8, b=5$ and $c=-9$ then the value of $\\sqrt{4a+8b-c}$ will be:",
                              "options": ["9", "12", "15", "8"],
                              "correct": 0
                            },
                            {
                              "question": "If $a+b=8$ and $ab=10,$ then the value of $a^{3}+b^{3}$ is:",
                              "options": ["312", "215", "272", "111"],
                              "correct": 2
                            },
                            {
                              "question": "If $x=2$ and $y=3$ then solve the expression $\\frac{\\sqrt{x}-\\sqrt{y}}{\\sqrt{x}+\\sqrt{y}}$",
                              "options": ["$2\\sqrt{6}-6$", "$5-2\\sqrt{6}$", "$2\\sqrt{6}-5$", "$\\sqrt{6}-5$"],
                              "correct": 2
                            },
                            {
                              "question": "If $a^{3}-b^{3}=899$ and $a-b=29,$ then the value of $(a-b)^{2}+3ab$ is equal to:",
                              "options": ["35", "16", "29", "31"],
                              "correct": 3
                            },
                            {
                              "question": "If $\\tan 3\\theta \\cdot \\tan 7\\theta = 1$. where $7\\theta$ is an acute angle, then find the value of $\\cot 15\\theta$.",
                              "options": ["$-\\sqrt{3}$", "1", "-1", "$\\sqrt{3}$"],
                              "correct": 2
                            },
                            {
                              "question": "The sum and difference of two numbers is 27 and 3 respectively. What is the ratio of two numbers?",
                              "options": ["$5:3$", "$2:1$", "$4:7$", "$5:4$"],
                              "correct": 3
                            },
                            {
                              "question": "If $a-b=3$ and $a^{3}-b^{3}=999$ then find the value of $a^{2}-b^{2}$.",
                              "options": ["60", "62", "64", "63"],
                              "correct": 3
                            },
                            {
                              "question": "If $x-4y=0$ and $x+2y=24,$ then what is the value of $\\frac{2x+3y}{2x-3y}$?",
                              "options": ["$\\frac{9}{5}$", "$\\frac{11}{5}$", "$\\frac{13}{7}$", "$\\frac{9}{7}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $\\sin \\theta=\\frac{9}{41}$ and $0^{\\circ}<\\theta<90^{\\circ}.$ then the value of $\\cot \\theta$ is:",
                              "options": ["$\\frac{39}{9}$", "$\\frac{35}{8}$", "$\\frac{40}{9}$", "$\\frac{47}{8}$"],
                              "correct": 2
                            },
                            {
                              "question": "If $\\sqrt{x}-\\frac{1}{\\sqrt{x}}=\\sqrt{3}$ then the value of $x^{4}+\\frac{1}{x^{4}}$ will be:",
                              "options": ["531", "623", "527", "7"],
                              "correct": 2
                            },
                            {
                              "question": "If $a+b+c=11$ and $ab+bc+ca=28$, then find the value of $a^{3}+b^{3}+c^{3}-3abc$.",
                              "options": ["1639", "407", "1093", "2255"],
                              "correct": 1
                            },
                            {
                              "question": "If $x^{2}-6x+1=0,$ then the value of $\\frac{x^{4}+x^{-2}}{x^{2}+1}$ is:",
                              "options": ["36", "33", "35", "39"],
                              "correct": 1
                            },
                            {
                              "question": "If $x^{4}+x^{-4}=6887$ then the positive value of $x-x^{-1}$ is:",
                              "options": ["9", "8", "12", "15"],
                              "correct": 0
                            },
                            {
                              "question": "If $x+y=4$ and $\\frac{1}{x}+\\frac{1}{y}=\\frac{16}{15},$ then what is the value of $(x^{3}+y^{3})$?",
                              "options": ["18", "16", "19", "21"],
                              "correct": 2
                            },
                            {
                              "question": "If $x^{2}-5\\sqrt{5}x+1=0$ and $x>0$ then the value of $(x^{3}-\\frac{1}{x^{3}})$ will be:",
                              "options": ["1331", "1296", "1244", "1364"],
                              "correct": 3
                            },
                            {
                              "question": "The value of $x^{3}+y^{3}+z^{3}-3xyz,$ when $x=555,$ $y=556$ and $z=557,$ is:",
                              "options": ["5006", "5002", "5004", "5008"],
                              "correct": 2
                            },
                            {
                              "question": "If $8 \\cot \\theta = 6$ then find the value of $\\frac{\\sin \\theta+\\cos \\theta}{\\sin \\theta-\\cos \\theta}$.",
                              "options": ["7", "2", "5", "12"],
                              "correct": 0
                            },
                            {
                              "question": "In $\\triangle ABC,$ $B$ is right angled and $\\cot A=\\frac{1}{2}$ then find the value of $\\frac{\\sin A(\\cos C+\\cos A)}{\\cos C(\\sin C-\\sin A)}$.",
                              "options": ["3", "-3", "2", "-2"],
                              "correct": 1
                            },
                            {
                              "question": "If $\\cos A = \\frac{9}{41}$, then find the value of $\\cot A$.",
                              "options": ["$\\frac{41}{40}$", "$\\frac{9}{40}$", "$\\frac{40}{9}$", "$\\frac{9}{41}$"],
                              "correct": 1
                            },
                            {
                              "question": "If $\\tan A = \\frac{5}{12}$ then the value of $\\cos A$ is:",
                              "options": ["$\\frac{5}{13}$", "$\\frac{13}{5}$", "$\\frac{12}{13}$", "$\\frac{12}{5}$"],
                              "correct": 2
                            },
                            {
                              "question": "If $\\frac{4}{3}(x^{2}+\\frac{1}{x^{2}})=110\\frac{2}{3}$ then find $\\frac{1}{9}(x^{3}-\\frac{1}{x^{3}});$ where $x>0$.",
                              "options": ["74", "85", "84", "76"],
                              "correct": 2
                            },
                            {
                              "question": "If $4x^{4}-37x^{2}+9=0$, $x>\\sqrt{\\frac{3}{2}}$, then what is the value of $8x^{3}-\\frac{27}{x^{3}}$?",
                              "options": ["35", "215", "-215", "-35"],
                              "correct": 1
                            },
                            {
                              "question": "If $x+\\frac{1}{x}=4$ then find the value of $x^{4}+\\frac{1}{x^{4}}$ is:",
                              "options": ["194", "196", "16", "14"],
                              "correct": 0
                            },
                            {
                              "question": "If $u+v=84$ and $u-v=4,$ then $u:v$ is equal to?",
                              "options": ["$11:10$", "$10:11$", "$10:9$", "$9:10$"],
                              "correct": 0
                            }

           
            /* ... rest of the 45 questions ... */
        ];

        // ---------- (to save space in this preview I will programmatically recreate the questions array)
        // If you're pasting this into production, be sure the questions array is identical to your original file.
        // For clarity: the final copy should contain the full questions list as in your original HTML.

        // State variables (unchanged)
        let currentQuestion = 0;
        let userAnswers = {};
        let userName = '';
        let userEmail = '';
        let examTimer;
        let timeRemaining = 75 * 60; // 1 hour 15 minutes in seconds
        let examStarted = false;

        // Initialize localStorage default for backward compatibility
        if (!localStorage.getItem('quizResponses')) {
            localStorage.setItem('quizResponses', JSON.stringify([]));
        }

        /***********************
         * JSONBin helper funcs
         ***********************/
        async function fetchResponsesFromBin() {
            try {
                const resp = await fetch(`${JSONBIN_BASE}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'Accept': 'application/json'
                    }
                });

                if (!resp.ok) {
                    console.warn('JSONBin fetch failed:', resp.status, resp.statusText);
                    throw new Error(`Fetch failed: ${resp.status}`);
                }

                const json = await resp.json();

                // JSONBin v3 can return the payload in different shapes; check common keys.
                // Try several fallbacks so this works for bins created in different styles.
                const payload = json?.record?.data ?? json?.record ?? json?.data ?? json;

                // Try common container keys, then fallback to payload itself if it's an array.
                if (Array.isArray(payload)) {
                    return payload;
                } else if (Array.isArray(payload.quizResponses)) {
                    return payload.quizResponses;
                } else if (Array.isArray(payload.responses)) {
                    return payload.responses;
                } else if (Array.isArray(payload.quiz_responses)) {
                    return payload.quiz_responses;
                } else {
                    // If the bin contains a single object with stored responses
                    return payload?.quizResponses || payload?.responses || [];
                }
            } catch (err) {
                console.warn('Error reading from JSONBin, falling back to localStorage. Error:', err);
                // fallback to localStorage
                const ls = JSON.parse(localStorage.getItem('quizResponses') || '[]');
                return ls;
            }
        }

        async function writeResponsesToBin(responsesArray) {
            try {
                const body = {
                    // store under a "quizResponses" key to make the bin structured and readable
                    data: {
                        quizResponses: responsesArray
                    }
                };

                const resp = await fetch(`${JSONBIN_BASE}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY
                    },
                    body: JSON.stringify(body)
                });

                if (!resp.ok) {
                    const txt = await resp.text();
                    console.error('JSONBin write failed:', resp.status, resp.statusText, txt);
                    throw new Error('JSONBin write failed');
                }

                // update localStorage as cache
                try {
                    localStorage.setItem('quizResponses', JSON.stringify(responsesArray));
                } catch (e) { console.warn('Could not write to localStorage:', e); }

                return true;
            } catch (err) {
                console.error('Error writing responses to JSONBin:', err);
                return false;
            }
        }

        async function appendResponseRemote(newResponse) {
            // atomic-ish: fetch, append, write. (Note: JSONBin does not provide transactions)
            const current = await fetchResponsesFromBin();
            current.push(newResponse);
            const ok = await writeResponsesToBin(current);
            return { ok, current };
        }

        // -------------------------
        // Existing exam logic (kept, with persistence changes)
        // -------------------------
        function startTimer() {
            examTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 300 && timeRemaining > 60) { // Last 5 minutes warning
                    document.getElementById('timerContainer').classList.add('timer-warning');
                    document.getElementById('autoSubmitWarning').style.display = 'block';
                } else if (timeRemaining <= 60) { // Last 1 minute critical
                    document.getElementById('timerContainer').classList.remove('timer-warning');
                    document.getElementById('timerContainer').classList.add('timer-critical');
                }

                if (timeRemaining <= 0) {
                    autoSubmitTest();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
        }

        function stopTimer() {
            if (examTimer) {
                clearInterval(examTimer);
                examTimer = null;
            }
        }

        function autoSubmitTest() {
            stopTimer();
            alert('⏰ Time\'s up! Your test has been automatically submitted.');
            submitTest(true); // true indicates auto-submission
        }

        function startTest() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
        }

        function startQuiz() {
            userName = document.getElementById('userName').value.trim();
            userEmail = document.getElementById('userEmail').value.trim();

            if (!userName || !userEmail) {
                alert('Please enter both name and email address');
                return;
            }

            if (!isValidEmail(userEmail)) {
                alert('Please enter a valid email address');
                return;
            }

            document.getElementById('userForm').style.display = 'none';
            document.getElementById('navigation').style.display = 'flex';
            
            generateQuestions();
            showQuestion(0);
            
            // Start the timer
            examStarted = true;
            startTimer();
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function generateQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.id = `question-${index}`;

                questionDiv.innerHTML = `
                    <div class="question">
                        <div class="question-header">
                            <span class="question-number">Question ${index + 1}</span>
                        </div>
                        <div class="question-text">${q.question}</div>
                        <ul class="options">
                            ${q.options.map((option, optIndex) => `
                                <li class="option" onclick="selectOption(${index}, ${optIndex})">
                                    <label>
                                        <input type="radio" name="question-${index}" value="${optIndex}" style="margin-right: 10px;">
                                        (${String.fromCharCode(65 + optIndex)}) ${option}
                                    </label>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;

                container.appendChild(questionDiv);
            });
        }

        function calculateScore(answers) {
            let correct = 0;
            let incorrect = 0;
            let unattempted = 0;
            let detailedResults = {};

            for (let i = 0; i < questions.length; i++) {
                const userAnswer = answers[i];
                const correctAnswer = questions[i].correct;
                
                if (userAnswer === undefined) {
                    unattempted++;
                    detailedResults[i] = {
                        status: 'unattempted',
                        icon: '–',
                        points: 0
                    };
                } else if (userAnswer === correctAnswer) {
                    correct++;
                    detailedResults[i] = {
                        status: 'correct',
                        icon: '✅',
                        points: 2
                    };
                } else {
                    incorrect++;
                    detailedResults[i] = {
                        status: 'incorrect',
                        icon: '❌',
                        points: -0.5
                    };
                }
            }

            const totalScore = (correct * 2) + (incorrect * -0.5);
            const percentage = ((correct * 2) / (questions.length * 2)) * 100;

            return {
                correct,
                incorrect,
                unattempted,
                totalScore,
                percentage: percentage.toFixed(2),
                maxMarks: questions.length * 2,
                detailedResults
            };
        }

        function selectOption(questionIndex, optionIndex) {
            // Remove previous selections
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach(opt => opt.classList.remove('selected'));

            // Add selection to clicked option
            options[optionIndex].classList.add('selected');

            // Store the answer
            userAnswers[questionIndex] = optionIndex;

            // Update radio button
            const radio = document.querySelector(`input[name="question-${questionIndex}"][value="${optionIndex}"]`);
            if (radio) radio.checked = true;
        }

        function showQuestion(index) {
            // Hide all questions
            document.querySelectorAll('.question-container').forEach(q => {
                q.classList.remove('active');
            });

            // Show current question
            document.getElementById(`question-${index}`).classList.add('active');

            // Update progress
            document.getElementById('progress').textContent = `Question ${index + 1} of ${questions.length}`;

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            if (prevBtn) prevBtn.disabled = (index === 0);
            
            if (index === questions.length - 1) {
                if (nextBtn) nextBtn.style.display = 'none';
                if (submitBtn) submitBtn.style.display = 'inline-block';
            } else {
                if (nextBtn) nextBtn.style.display = 'inline-block';
                if (submitBtn) submitBtn.style.display = 'none';
            }

            currentQuestion = index;
            
            // **********************************************
            // ADD THIS LINE TO RENDER MATH IN NEWLY SHOWN QUESTION
            // **********************************************
            MathJax.typeset(); 
            // **********************************************
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                showQuestion(currentQuestion - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                showQuestion(currentQuestion + 1);
            }
        }

        async function submitTest(isAutoSubmit = false) {
            stopTimer(); // Stop the timer immediately
            
            const confirmMessage = isAutoSubmit ? 
                'Your test has been auto-submitted due to time expiry.' :
                'Are you sure you want to submit your test? You cannot change your answers after submission.';
                
            if (!isAutoSubmit && !confirm(confirmMessage)) {
                // Restart timer if user cancels submission
                if (examStarted) {
                    startTimer();
                }
                return;
            }

            try {
                // Calculate score and results
                const scoreData = calculateScore(userAnswers);
                
                // Store user response with all question-answer details
                const response = {
                    name: userName,
                    email: userEmail,
                    answers: userAnswers,
                    detailedAnswers: {},
                    scoreData: scoreData,
                    timestamp: new Date().toISOString(),
                    submittedAt: new Date().toLocaleString(),
                    isAutoSubmitted: isAutoSubmit,
                    timeSpent: (75 * 60) - timeRemaining // Calculate time spent
                };

                // Create detailed answers for admin panel
                for (let i = 0; i < questions.length; i++) {
                    const userAnswer = userAnswers[i];
                    response.detailedAnswers[i] = {
                        questionText: questions[i].question,
                        userAnswerIndex: userAnswer !== undefined ? userAnswer : null,
                        userAnswerText: userAnswer !== undefined ? questions[i].options[userAnswer] : 'Not answered',
                        userAnswerLetter: userAnswer !== undefined ? String.fromCharCode(65 + userAnswer) : '-'
                    };
                }

                // First try to save remotely to JSONBin
                const { ok, current } = await appendResponseRemote(response);

                if (ok) {
                    console.log('Saved response to JSONBin successfully.');
                    alert('Your test has been submitted and saved to server.');
                } else {
                    // fallback: store locally
                    console.warn('Failed to save to JSONBin; storing in localStorage as fallback.');
                    let responses = JSON.parse(localStorage.getItem('quizResponses') || '[]');
                    responses.push(response);
                    localStorage.setItem('quizResponses', JSON.stringify(responses));
                    alert('Your test has been submitted locally (server save failed).');
                }

                // Hide quiz and show success message
                document.getElementById('quizContainer').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';

                console.log('Test submitted', response);
            } catch (error) {
                console.error('Error saving response:', error);
                // fallback: store locally
                let responses = JSON.parse(localStorage.getItem('quizResponses') || '[]');
                responses.push({
                    name: userName,
                    email: userEmail,
                    answers: userAnswers,
                    scoreData: calculateScore(userAnswers),
                    timestamp: new Date().toISOString(),
                    submittedAt: new Date().toLocaleString(),
                    isAutoSubmitted: isAutoSubmit,
                    timeSpent: (75 * 60) - timeRemaining
                });
                localStorage.setItem('quizResponses', JSON.stringify(responses));

                // Even if there's an error, close the test
                document.getElementById('quizContainer').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                alert('There was a problem saving to server — response saved locally.');
            }
        }

        function openAdminModal() {
            document.getElementById('adminModal').style.display = 'block';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'AryanM@123M') {
                closeAdminModal();
                showAdminPanel();
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }

        async function showAdminPanel() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            await displayResponses();
        }

        async function displayResponses() {
    const container = document.getElementById('responsesContainer');

    // Try remote fetch first
    const responses = await fetchResponsesFromBin();

    if (!responses || responses.length === 0) {
        container.innerHTML = '<p>No responses yet.</p>';
        return;
    }

    let html = `<h3>Total Responses: ${responses.length}</h3>`;
    
    responses.forEach((response, responseIndex) => {
        const timeSpentMinutes = Math.floor((response.timeSpent || 0) / 60);
        const timeSpentSeconds = (response.timeSpent || 0) % 60;
        const timeSpentDisplay = `${timeSpentMinutes}m ${timeSpentSeconds}s`;
        
        // Get score data (calculate if not present for backward compatibility)
        let scoreData = response.scoreData;
        if (!scoreData) {
            scoreData = calculateScore(response.answers || {});
        }
        
        html += `<div style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">`;
        html += `<h4>Response #${responseIndex + 1}</h4>`;
        html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">`;
        html += `<p><strong>Name:</strong> ${response.name || '—'}</p>`;
        html += `<p><strong>Email:</strong> ${response.email || '—'}</p>`;
        html += `<p><strong>Score:</strong> ${scoreData.totalScore}/${scoreData.maxMarks}</p>`;
        html += `<p><strong>Percentage:</strong> ${scoreData.percentage}%</p>`;
        html += `</div>`;
        
        html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px;">`;
        html += `<p style="margin: 0;"><span style="color: #27ae60;">✅ Correct:</span> ${scoreData.correct}</p>`;
        html += `<p style="margin: 0;"><span style="color: #e74c3c;">❌ Incorrect:</span> ${scoreData.incorrect}</p>`;
        html += `<p style="margin: 0;"><span style="color: #95a5a6;">– Unattempted:</span> ${scoreData.unattempted}</p>`;
        html += `<p style="margin: 0;"><strong>Time:</strong> ${timeSpentDisplay}</p>`;
        html += `<p style="margin: 0;"><strong>Auto Submit:</strong> ${response.isAutoSubmitted ? 'Yes' : 'No'}</p>`;
        html += `</div>`;
        
        html += `<p><strong>Submitted At:</strong> ${response.submittedAt}</p>`;
        html += `<h5 style="margin-top: 20px;">Question-wise Results:</h5>`;
        
        html += '<div style="overflow-x: auto;"><table class="response-table" style="width: 100%; font-size: 12px;"><thead><tr>';
        html += '<th style="width: 6%;">Q#</th><th style="width: 6%;">Result</th><th style="width: 8%;">Points</th><th style="width: 50%;">Question</th><th style="width: 15%;">User Answer</th><th style="width: 15%;">Correct Answer</th></tr></thead><tbody>';
        
        for (let i = 0; i < questions.length; i++) {
            const userAnswer = (response.answers || {})[i];
            const correctAnswer = questions[i].correct;
            
            // --- FIX 1: Show full question text
            const fullQuestionText = questions[i].question;
            
            const resultIcon = scoreData.detailedResults[i]?.icon || '–';
            const points = scoreData.detailedResults[i]?.points || 0;
            
            html += '<tr>';
            html += `<td>${i + 1}</td>`;
            html += `<td style="font-size: 16px; text-align: center;">${resultIcon}</td>`;
            html += `<td style="font-weight: bold; color: ${points > 0 ? '#27ae60' : points < 0 ? '#e74c3c' : '#95a5a6'};">${points > 0 ? '+' : ''}${points}</td>`;
            
            // --- FIX 2: Render LaTeX math and show full text
            // Note: We use MathJax.typesetPromise() after the table is added to the DOM to actually render the math.
            html += `<td class="math-question" id="q-admin-${responseIndex}-${i}" style="font-size: 11px;">${fullQuestionText}</td>`;
            
            if (userAnswer !== undefined && userAnswer !== null) {
                html += `<td style="font-size: 11px;">${String.fromCharCode(65 + userAnswer)}) ${questions[i].options[userAnswer]}</td>`;
            } else {
                html += `<td style="color: #999;">Not answered</td>`;
            }
            
            html += `<td style="font-size: 11px; color: #27ae60; font-weight: bold;">${String.fromCharCode(65 + correctAnswer)}) ${questions[i].options[correctAnswer]}</td>`;
            html += '</tr>';
        }
        
        html += '</tbody></table></div>';
        html += '</div>';
    });

    container.innerHTML = html;
    
    // **********************************************
    // CRITICAL: Trigger MathJax to render the content in the Admin Panel
    // **********************************************
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise();
    }
}
// Helper function to clean LaTeX math for readable CSV output (for display/readability)
function cleanMathText(text) {
    if (typeof text !== 'string') return String(text);

    let cleaned = text;

    // 1. Remove LaTeX delimiters ($)
    cleaned = cleaned.replace(/\$/g, '');

    // 2. Replace common LaTeX commands with readable symbols
    cleaned = cleaned.replace(/\\frac{(.*?)}{(.*?)}/g, '($1/$2)'); // Fractions -> (num/den)
    cleaned = cleaned.replace(/\\sqrt{(.*?)}/g, 'sqrt($1)');      // Square roots -> sqrt(value)
    cleaned = cleaned.replace(/\\cos/g, 'cos');
    cleaned = cleaned.replace(/\\sin/g, 'sin');
    cleaned = cleaned.replace(/\\tan/g, 'tan');
    cleaned = cleaned.replace(/\\cot/g, 'cot');
    cleaned = cleaned.replace(/\\sec/g, 'sec');
    cleaned = cleaned.replace(/\\csc/g, 'csc');
    cleaned = cleaned.replace(/\\pm/g, '+/-');
    cleaned = cleaned.replace(/\\text{(.*?)}/g, '$1');
    cleaned = cleaned.replace(/\\circ/g, ' deg');

    return cleaned.trim();
}

// Helper function to escape text for CSV (handles commas and quotes in data fields)
function escapeForCSV(text) {
    if (text === null || text === undefined) return '';
    const str = String(text).replace(/"/g, '""');
    return `"${str}"`;
}

// Helper function to trigger the browser download (kept from previous response)
function triggerDownload(data, filename) {
    const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    
    if (link.download !== undefined) { 
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        alert('Your browser does not support direct downloading. Please copy and paste the data.');
    }
}


/**
 * DOWNLOAD FINAL RESULTS (CSV)
 * Contains: Score metrics, Time Taken, and Question-wise breakdown (User vs Correct)
 * Each User section starts with a summary row, followed by rows for each question.
 */
async function downloadResultsCSV() {
    const responses = await fetchResponsesFromBin();
    
    if (!responses || responses.length === 0) {
        alert('No results to download');
        return;
    }

    // 1. Define Master Headers (For the per-question rows)
    const questionHeaders = ["User Status", "Q#", "Result", "Points", "Time (min)", "Question Text", "User Answer", "Correct Answer"];
    let csvContent = questionHeaders.map(escapeForCSV).join(",") + "\n";

    // 2. Map Data
    responses.forEach(response => {
        let scoreData = response.scoreData || calculateScore(response.answers || {});
        const timeSpentMinutes = ((response.timeSpent || 0) / 60).toFixed(2);

        // --- USER HEADER ROW (New Row Type) ---
        const userHeader = [
            `USER: ${response.name} (${response.email})`, 
            `SCORE: ${scoreData.totalScore.toFixed(2)}/${scoreData.maxMarks}`,
            `PERCENTAGE: ${scoreData.percentage}%`, 
            `CORRECT: ${scoreData.correct}`, 
            `INCORRECT: ${scoreData.incorrect}`, 
            `UNATTEMPTED: ${scoreData.unattempted}`,
            `TIME TAKEN: ${timeSpentMinutes} min`, 
            `SUBMITTED: ${response.submittedAt}`, 
            `AUTO-SUBMIT: ${response.isAutoSubmitted ? 'Yes' : 'No'}`
        ];
        csvContent += userHeader.map(escapeForCSV).join(",") + "\n";

        // --- QUESTION ROWS ---
        for (let i = 0; i < questions.length; i++) {
            const question = questions[i];
            const userAnswerIndex = (response.answers || {})[i];
            const correctAnswerIndex = question.correct;
            const result = scoreData.detailedResults[i];

            const userStatus = result?.status.toUpperCase() || 'UNATTEMPTED';

            // Prepare User Answer Text
            let userAnswerText = 'Not Answered';
            if (userAnswerIndex !== undefined && userAnswerIndex !== null) {
                const optionLetter = String.fromCharCode(65 + userAnswerIndex);
                userAnswerText = `${optionLetter}) ${cleanMathText(question.options[userAnswerIndex])}`;
            }

            // Prepare Correct Answer Text
            const correctLetter = String.fromCharCode(65 + correctAnswerIndex);
            const correctAnswerText = `${correctLetter}) ${cleanMathText(question.options[correctAnswerIndex])}`;

            const questionRow = [
                userStatus,
                i + 1,
                userStatus === 'CORRECT' ? 'C' : userStatus === 'INCORRECT' ? 'I' : 'U',
                result?.points || 0,
                timeSpentMinutes,
                cleanMathText(question.question), 
                userAnswerText,
                correctAnswerText
            ];
            
            csvContent += questionRow.map(escapeForCSV).join(",") + "\n";
        }
    });

    // 3. Trigger Download
    triggerDownload(csvContent, `ssc_chsl_final_results_${new Date().toISOString().split('T')[0]}.csv`);
}


/**
 * DOWNLOAD RAW DATA (CSV)
 * Contains: Only Question Text, Options, and User Selection (no scoring metadata in rows).
 */
async function downloadRawDataCSV() {
    const responses = await fetchResponsesFromBin();
    
    if (!responses || responses.length === 0) {
        alert('No raw data to download');
        return;
    }
    
    // 1. Define Master Headers (For the per-question rows)
    const rawHeaders = ["User Name", "Q#", "Question Text", "All Options", "User Selection"];
    let csvContent = rawHeaders.map(escapeForCSV).join(",") + "\n";
    
    // 2. Map Data
    responses.forEach(response => {
        const userNameHeader = [`USER: ${response.name} (${response.email})`];
        csvContent += userNameHeader.map(escapeForCSV).join(",") + "\n";
        
        // --- QUESTION ROWS ---
        for (let i = 0; i < questions.length; i++) {
            const question = questions[i];
            const userAnswerIndex = (response.answers || {})[i];
            
            // Col 3: All Options Text (Cleaned)
            const allOptions = question.options.map((opt, idx) => 
                `${String.fromCharCode(65 + idx)}) ${cleanMathText(opt)}`
            ).join(' | ');
            
            // Col 4: User Selected Option (Cleaned)
            let userAnswerText = 'Not Answered';
            if (userAnswerIndex !== undefined && userAnswerIndex !== null) {
                const optionLetter = String.fromCharCode(65 + userAnswerIndex);
                const optionText = cleanMathText(question.options[userAnswerIndex]);
                userAnswerText = `${optionLetter}) ${optionText}`;
            }
            
            const questionRow = [
                response.name,
                i + 1,
                cleanMathText(question.question),
                allOptions,
                userAnswerText
            ];
            
            csvContent += questionRow.map(escapeForCSV).join(",") + "\n";
        }
    });

    // 3. Trigger Download
    triggerDownload(csvContent, `ssc_chsl_raw_data_${new Date().toISOString().split('T')[0]}.csv`);
}
        async function clearAllResponses() {
            if (!confirm('Are you sure you want to delete all user responses? This cannot be undone.')) {
                return;
            }

            // For safety: clear localStorage, then try to write an empty array to JSONBin
            localStorage.removeItem('quizResponses');

            const ok = await writeResponsesToBin([]);

            if (ok) {
                await displayResponses();
                alert('All responses have been cleared from the server and local cache.');
            } else {
                alert('Failed to clear responses on server. Local responses cleared only.');
                await displayResponses();
            }
        }

        function goHome() {
            stopTimer(); // Stop timer when going home
            
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            
            // Reset quiz state
            currentQuestion = 0;
            userAnswers = {};
            userName = '';
            userEmail = '';
            timeRemaining = 75 * 60; // Reset timer
            examStarted = false;
            updateTimerDisplay();
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('navigation').style.display = 'none';
            document.getElementById('autoSubmitWarning').style.display = 'none';
            document.getElementById('timerContainer').classList.remove('timer-warning', 'timer-critical');
        }

        // Prevent page refresh/close during exam
        window.addEventListener('beforeunload', function (e) {
            if (examStarted && timeRemaining > 0) {
                const message = 'Your exam is in progress. Are you sure you want to leave? Your progress will be lost.';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('adminModal');
            if (event.target === modal) {
                closeAdminModal();
            }
        }

        // Handle Enter key in password field
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAdminPassword();
                }
            });
            
            // Initialize timer display
            updateTimerDisplay();
        });

        // Prevent right-click context menu during exam
        document.addEventListener('contextmenu', function(e) {
            if (examStarted) {
                e.preventDefault();
            }
        });

        // Prevent common keyboard shortcuts during exam
        document.addEventListener('keydown', function(e) {
            if (examStarted) {
                // Prevent F5 (refresh)
                if (e.key === 'F5') {
                    e.preventDefault();
                }
                // Prevent Ctrl+R (refresh)
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                }
                // Prevent F12 (developer tools)
                if (e.key === 'F12') {
                    e.preventDefault();
                }
            }
        });
    </script>
</body>
</html>